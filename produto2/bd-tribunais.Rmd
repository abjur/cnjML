---
output: 
  bookdown::pdf_document2:
    keep_tex: true
---

```{r knit, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
```

```{r}
library(tidyverse)
library(lubridate)
library(stringr)
library(forcats)
library(glue)
theme_cnj <- function() {
  theme_bw(14)
}
fmt <- function(n) {
  format(n, big.mark = ',', decimal.mark = '.')
}
fct_lump2 <- function(f, reps) {
  ord <- order(reps)
  v <- rep(f, ord)
  inds <- cumsum(ord)
  forcats::fct_lump(v, n = 10, other_level = 'Outros')[inds]
}
```


# Descrição dos dados disponíveis até o momento

Atualmente temos disponíveis as bases de dados do TJSP, TJRJ e TJRS. As bases do TJBA e TJAM estão sendo baixadas diretamente dos tribunais e ainda estamos aguardando o envio do TJDFT e TJMS. Também temos disponíveis as bases de dados do Sistema Nacional de Informações de Defesa do Consumidor (Sindec) e do Consumidor.gov, que contém informações sobre composição extrajudicial.

## Bases de dados dos tribunais

As bases de dados do TJSP e TJRS apresentam estruturas similares pois foram obtidas a partir da especificação do ofício da ABJ para extração de dados. Já a base do TJRJ apresenta uma estrutura completamente diferente e exige uma análise específica. A única diferença entre as bases do TJSP e do TJRS é que o primeiro precisou de uma descrição mais detalhada dos assuntos processuais que entraram nos filtros para extração de dados.

Nas próximas subseções apresentamos as principais características das bases obtidas.

### Tribunal de Justiça de São Paulo

O ofício é composto de duas tabelas: informações básicas e movimentações. A primeira contém dados do número do processo, data de distribuição, classe, assunto, comarca, foro, autor, réu, e valor da causa. A segunda contém as datas e títulos de todas as movimentações do processo. Esta tabela é usualmente volumosa pois somente um processo pode ter centenas de movimentações.

Em relação ao escopo, nossa estratégia foi incluir filtros genéricos para não correr o risco de cortar processos de interesse. Não fizemos filtros de classe/assunto e pedimos todos os processos cíveis distribuídos entre 2009 e 2015 em todo o estado.

Nos primeiros contatos com o TJSP, fomos informados que não seria possível fazer a extração com um escopo amplo e que seria necessário informar quais os assuntos processuais gostaríamos de incluir. 

O problema é que assuntos processuais não são confiáveis. De fato, existem assuntos que são facilmente associados a processos envolvendo direito do consumidor. No entanto, em muitos casos a interpretação é ambígua. Tome por exemplo os processos classificados como "DIREITO CIVIL" (que existem, e em grande volume.) Esses casos podem envolver ou não direito do consumidor, mas é necessário analisar os dados para descobrir. A solução foi criar uma lista genérica contendo os assuntos que *estão ou podem estar* associados ao direito do consumidor. Chamamos essa lista de *whitelist*.

Para criar a whitelist, utilizamos duas estratégias. A primeira envolveu coletar uma amostra de até 100 sentenças de cada assunto processual automaticamente do TJSP, verificando se alguma delas continha palavras-chave relacionadas ao direito do consumidor, como "consumo", "CDC" e "Lei 8.078/1990" (CDC). A segunda abordagem foi analisar cada assunto processual e verificar se teoricamente ele poderia envolver direito do consumidor. As duas estratégias levaram a resultados similares. A whitelist final leva em conta 270 assuntos distintos.

```{r}
tabs <- readRDS("tabs_tjsp.rds")
```

A base recebida contém 8.557.292 linhas. Para a elaboração desta análise preliminar, aplicamos os seguintes filtros:

- Data da última distribuição entre 2009 e 2015.
- Retiradas duplicatas de números de processo: quando o número repete, consideramos aquele com data de distribuição mais recente.

O resultado foi uma tabela de 8.468.262 linhas.

**Data de distribuição**. A Tabela \@ref(tab:tab-tjsp-vol-anos) mostra o volume de processos por ano. O volume aumentou ao longo dos anos, o que indica i) aumento da litigiosidade ou ii) melhora na documentação dos processos.

```{r tab-tjsp-vol-anos}
tabs[[1]] %>% 
  mutate(`Proporção` = n/sum(n)) %>% 
  janitor::add_totals_row() %>% 
  mutate(`Proporção` = scales::percent(`Proporção`),
         n = fmt(n)) %>% 
  knitr::kable(caption = 'Volume de processos por ano.',
               booktabs = TRUE, align = c('l', 'r', 'r'))
```

A Figura \@ref(fig:fig-tjsp-vol-meses) mostra a evolução mensal do volume de processos por ano. Podemos observar uma queda sistemática no volume em dezembro e janeiro, mas além disso não existem muitos sinais de sazonalidade.

```{r fig-tjsp-vol-meses, fig.cap='Volume processual mensal em cada ano.', fig.width=9, fig.height=3}
tabs[[2]] %>% 
  ggplot(aes(x = mon, y = n, colour = year)) +
  geom_point() +
  geom_line() +
  scale_x_date(labels = scales::date_format('%b'),
               breaks = scales::date_breaks()) +
  scale_y_continuous(labels = fmt) +
  labs(x = 'Mês', y = 'Volume processual', colour = 'Ano') +
  theme_cnj()
```

**Classe e assunto**. A Tabela \@ref(tab:tab-classe) mostra o volume de processos das dez classes com mais processos. As ações concentram-se em procedimentos dos JECs e procedimentos comuns. O volume de execuções de título extrajudicial terá uma queda ao considerar apenas pessoas físicas como autores.

```{r tab-classe}
tabs[[3]] %>% 
  group_by(classe) %>% 
  summarise(n = sum(n)) %>% 
  arrange(n) %>% 
  mutate(classe = fct_lump2(classe, n)) %>% 
  group_by(classe) %>% 
  summarise(n = sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(`Proporção` = n / sum(n)) %>% 
  janitor::add_totals_row() %>% 
  mutate(`Proporção` = scales::percent(`Proporção`),
         n = fmt(n)) %>% 
  slice(c(2:11, 1, 12)) %>% 
  knitr::kable(caption = 'Volume processual das dez classes com mais processos.',
               booktabs = TRUE, align = c('l', 'r', 'r'))
```

A Tabela \@ref(tab:tab-assunto) mostra o volume de processos dos dez assuntos com maior volume processual. Apesar da concentração em alienação fiduciária, obrigações e contratos, observamos que os dez assuntos com maior volume concentram menos de 50% dos casos.

```{r tab-assunto}
tabs[[3]] %>% 
  group_by(assunto) %>% 
  summarise(n = sum(n)) %>% 
  arrange(n) %>% 
  mutate(assunto = fct_lump2(assunto, n)) %>% 
  group_by(assunto) %>% 
  summarise(n = sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(`Proporção` = n / sum(n)) %>% 
  janitor::add_totals_row() %>% 
  mutate(`Proporção` = scales::percent(`Proporção`),
         n = fmt(n)) %>% 
  slice(c(2:11, 1, 12)) %>% 
  knitr::kable(caption = 'Volume processual dos dez assuntos com mais processos.',
               booktabs = TRUE, align = c('l', 'r', 'r'))
```

**Comarca**. A Tabela \@ref(tab:tab-comarca) mostra o volume de processos dos dez foros com maior volume processual (os foros receberam o nome da comarca correspondente nos casos que não geram ambiguidade). A maior parte dos foros fazem parte da comarca da capital. É como se a comarca de São Paulo fosse um tribunal separado. Isso indica que precisamos fazer análises separando capital e outras comarcas.

```{r tab-comarca}
tabs[[4]] %>% 
  group_by(comarca) %>% 
  summarise(n = sum(n)) %>% 
  arrange(n) %>% 
  mutate(comarca = fct_lump2(comarca, n)) %>% 
  group_by(comarca) %>% 
  summarise(n = sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(`Proporção` = n / sum(n)) %>% 
  janitor::add_totals_row() %>% 
  mutate(`Proporção` = scales::percent(`Proporção`),
         n = fmt(n)) %>% 
  slice(c(2:11, 1, 12)) %>% 
  knitr::kable(caption = 'Volume processual dos dez foros com mais processos.',
               booktabs = TRUE, align = c('l', 'r', 'r'))
```


**Réus**. Para analisar os réus, fizemos uma pequena limpeza nos nomes, retirando acentos e colocando todos os nomes em caixa alta. A Tabela \@ref(tab:reu) mostra os resultados. A tabela mostra repetições de Banco do Brasil e Bradesco. Isso mostra que será necessário realizar mais ajustes para identificar os maiores litigantes com precisão.

```{r reu}
ntot <- sum(tabs[[5]]$n)

aux <- tabs[[5]] %>% 
  arrange(n) %>% 
  filter(n > 1000) %>% 
  mutate(reu = fct_lump2(reu, n)) %>% 
  group_by(reu) %>% 
  summarise(n = sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(`Proporção` = n / sum(n))
  
n_outros <- ntot - sum(filter(aux, reu != 'Outros')$n)
prop_outros <- n_outros / ntot

aux %>% 
  mutate(reu = if_else(as.character(reu) == '', 
                       '(vazio)', 
                       as.character(reu))) %>% 
  mutate(n = if_else(reu == 'Outros', n_outros, n)) %>% 
  mutate(`Proporção` = if_else(reu == 'Outros', prop_outros, `Proporção`)) %>% 
  mutate(`Proporção` = scales::percent(`Proporção`),
         n = fmt(n)) %>%
  slice(c(2:11, 1)) %>% 
  tibble::add_row(reu = "Total", n = fmt(ntot), `Proporção` = '100.0%') %>% 
  knitr::kable(caption = 'Valores médios e medianos dos processos, considerando os 10 assuntos com maiores valores medianos.',
               booktabs = TRUE, align = c('l', 'r', 'r'))

```

**Valores**. A Tabela \@ref(tab:vl) mostra os dez assuntos com maiores valores medianos (considerando somente assuntos com cem ou mais processos). Observe que os valores apresentam acentuada assimetria à direita, pois os valores médios são muito maiores que os medianos. Note também que nem todos os assuntos envolvem direito do consumidor diretamente.

```{r vl}
tabs[[6]] %>% 
  filter(n > 100) %>% 
  arrange(desc(m2)) %>%
  select(Assunto = assunto, n, `Faltantes` = n_na,
         `Média` = m1, Mediana = m2) %>% 
  mutate_if(is.double, scales::dollar) %>% 
  head(10) %>% 
  knitr::kable(caption = 'Valores médios e medianos dos processos com valor maior que zero, considerando os 10 assuntos com maiores valores medianos.',
               booktabs = TRUE, align = c('l', 'r', 'r', 'r', 'r'))
```

A Tabela \@ref(tab:vl0) mostra os dez assuntos com maiores valores medianos, considerando apenas os processos com valores de causa maiores que zero. Note que ao retirar os zeros, os valores médios e medianos aumentam significativamente em relação à tabela anterior.  

```{r vl0}
tabs[[6]] %>% 
  filter(n > 100) %>% 
  arrange(desc(m4)) %>%
  select(Assunto = assunto, n, `Faltantes` = n_na,
         `Média` = m3, Mediana = m4) %>% 
  mutate_if(is.double, scales::dollar) %>% 
  head(10) %>%   
  knitr::kable(caption = 'Valores médios e medianos dos processos com valor maior que zero, considerando os 10 assuntos com maiores valores medianos.',
               booktabs = TRUE, align = c('l', 'r', 'r', 'r', 'r'))
```

### Tribunal de Justiça do Rio Grande do Sul

A estrutura das tabelas do TJRS é idêntica à do TJSP, com exceção da whitelist. Isso significa que as análises abaixo representam a totalidade de processos cíveis do TJRS e não somente os casos relacionados com direito do consumidor.

```{r}
tabs <- readRDS("tabs_tjrs.rds")
```

A base recebida contém 6.264.071 linhas. Para a elaboração desta análise preliminar, aplicamos os seguintes filtros:

- Data da última distribuição entre 2009 e 2015.
- Retiradas duplicatas de números de processo: quando o número repete, consideramos aquele com data de distribuição mais recente.

O resultado foi uma tabela de 6.263.710 linhas.

**Data de distribuição**. A Tabela \@ref(tab:tab-tjrs-vol-anos) mostra o volume de processos por ano. Ao contrário do TJSP, o volume reduziu ao longo dos anos. Uma explicação para isso pode ser a redução da litigiosidade.

```{r tab-tjrs-vol-anos}
tabs[[1]] %>% 
  mutate(`Proporção` = n/sum(n)) %>% 
  janitor::add_totals_row() %>% 
  mutate(`Proporção` = scales::percent(`Proporção`),
         n = fmt(n)) %>% 
  knitr::kable(caption = 'Volume de processos por ano.',
               booktabs = TRUE, align = c('l', 'r', 'r'))
```

A Figura \@ref(fig:fig-tjrs-vol-meses) mostra a evolução mensal do volume de processos por ano. Podemos observar uma queda sistemática no volume em dezembro, janeiro e fevereiro, com picos em março e outubro.

```{r fig-tjrs-vol-meses, fig.cap='Volume processual mensal em cada ano.', fig.width=9, fig.height=3}
tabs[[2]] %>% 
  ggplot(aes(x = mon, y = n, colour = year)) +
  geom_point() +
  geom_line() +
  scale_x_date(labels = scales::date_format('%b'),
               breaks = scales::date_breaks()) +
  scale_y_continuous(labels = fmt) +
  labs(x = 'Mês', y = 'Volume processual', colour = 'Ano') +
  theme_cnj()
```

**Classe e assunto**. A Tabela \@ref(tab:tjrs-tab-classe) mostra o volume de processos das dez classes com mais processos. As ações concentram-se em procedimentos dos JECs, procedimentos comuns e cartas precatórias.

```{r tjrs-tab-classe}
tabs[[3]] %>% 
  group_by(classe) %>% 
  summarise(n = sum(n)) %>% 
  arrange(n) %>% 
  mutate(classe = fct_lump2(classe, n)) %>% 
  group_by(classe) %>% 
  summarise(n = sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(`Proporção` = n / sum(n)) %>% 
  janitor::add_totals_row() %>% 
  mutate(`Proporção` = scales::percent(`Proporção`),
         n = fmt(n)) %>% 
  slice(c(1:3, 5:11, 4, 12)) %>% 
  knitr::kable(caption = 'Volume processual das dez classes com mais processos.',
               booktabs = TRUE, align = c('l', 'r', 'r'))
```

A Tabela \@ref(tab:tjrs-tab-assunto) mostra o volume de processos dos dez assuntos com maior volume processual. Os dez assuntos com maior volume concentram menos de 50% dos casos, e quase 14% dos casos não possuem assunto informado.

```{r tjrs-tab-assunto}
tabs[[3]] %>% 
  group_by(assunto) %>% 
  summarise(n = sum(n)) %>% 
  arrange(n) %>% 
  mutate(assunto = fct_lump2(assunto, n)) %>% 
  group_by(assunto) %>% 
  summarise(n = sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(`Proporção` = n / sum(n)) %>% 
  janitor::add_totals_row() %>% 
  mutate(`Proporção` = scales::percent(`Proporção`),
         n = fmt(n)) %>% 
  slice(c(2:11, 1, 12)) %>% 
  knitr::kable(caption = 'Volume processual dos dez assuntos com mais processos.',
               booktabs = TRUE, align = c('l', 'r', 'r'))
```

**Comarca**. A Tabela \@ref(tab:tjrs-tab-comarca) mostra o volume de processos das dez comarcas com maior volume processual. Aproximadamente um quarto dos casos aparecem na capital Porto Alegre.

```{r tjrs-tab-comarca}
tabs[[4]] %>% 
  group_by(comarca) %>% 
  summarise(n = sum(n)) %>% 
  arrange(n) %>% 
  mutate(comarca = fct_lump2(comarca, n)) %>% 
  group_by(comarca) %>% 
  summarise(n = sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(`Proporção` = n / sum(n)) %>% 
  janitor::add_totals_row() %>% 
  mutate(`Proporção` = scales::percent(`Proporção`),
         n = fmt(n)) %>% 
  slice(c(2:11, 1, 12)) %>% 
  knitr::kable(caption = 'Volume processual dos dez foros com mais processos.',
               booktabs = TRUE, align = c('l', 'r', 'r'))
```


**Réus**. Para analisar os réus, fizemos uma pequena limpeza nos nomes, retirando acentos e colocando todos os nomes em caixa alta. A Tabela \@ref(tab:tjrs-reu) mostra os resultados. Nessa tabela aparece duplicado o nome da Brasil Telecom.

```{r tjrs-reu}
ntot <- sum(tabs[[5]]$n)

aux <- tabs[[5]] %>% 
  replace_na(list(reu = '')) %>% 
  arrange(n) %>% 
  filter(n > 1000) %>% 
  mutate(reu = fct_lump2(reu, n)) %>% 
  group_by(reu) %>% 
  summarise(n = sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(`Proporção` = n / sum(n))
  
n_outros <- ntot - sum(filter(aux, reu != 'Outros')$n)
prop_outros <- n_outros / ntot

aux %>% 
  mutate(reu = if_else(as.character(reu) == '', 
                       '(vazio)', 
                       as.character(reu))) %>% 
  mutate(n = if_else(reu == 'Outros', n_outros, n)) %>% 
  mutate(`Proporção` = if_else(reu == 'Outros', prop_outros, `Proporção`)) %>% 
  mutate(`Proporção` = scales::percent(`Proporção`),
         n = fmt(n)) %>%
  slice(c(2:11, 1)) %>% 
  tibble::add_row(reu = "Total", n = fmt(ntot), `Proporção` = '100.0%') %>% 
  knitr::kable(caption = 'Valores médios e medianos dos processos, considerando os 10 assuntos com maiores valores medianos.',
               booktabs = TRUE, align = c('l', 'r', 'r'))

```

**Valores**. A Tabela \@ref(tab:tjrs-vl) mostra os dez assuntos com maiores valores medianos (considerando somente assuntos com cem ou mais processos). Observe que os valores apresentam acentuada assimetria à direita, pois os valores médios são muito maiores que os medianos. Note também que nem todos os assuntos envolvem direito do consumidor diretamente.

```{r tjrs-vl}
tabs[[6]] %>% 
  filter(n > 100) %>% 
  arrange(desc(m2)) %>%
  select(Assunto = assunto, n, `Faltantes` = n_na,
         `Média` = m1, Mediana = m2) %>% 
  mutate_if(is.double, scales::dollar) %>% 
  head(10) %>% 
  knitr::kable(caption = 'Valores médios e medianos dos processos com valor maior que zero, considerando os 10 assuntos com maiores valores medianos.',
               booktabs = TRUE, align = c('l', 'r', 'r', 'r', 'r'))
```

A Tabela \@ref(tab:tjrs-vl0) mostra os dez assuntos com maiores valores medianos, considerando apenas os processos com valores de causa maiores que zero. Nesse caso não há diferenças entre as duas tabelas, ou seja, os valores no TJRS são sempre positivos.

```{r tjrs-vl0}
tabs[[6]] %>% 
  filter(n > 100) %>% 
  arrange(desc(m4)) %>%
  select(Assunto = assunto, n, `Faltantes` = n_na,
         `Média` = m3, Mediana = m4) %>% 
  mutate_if(is.double, scales::dollar) %>% 
  head(10) %>%   
  knitr::kable(caption = 'Valores médios e medianos dos processos com valor maior que zero, considerando os 10 assuntos com maiores valores medianos.',
               booktabs = TRUE, align = c('l', 'r', 'r', 'r', 'r'))
```

